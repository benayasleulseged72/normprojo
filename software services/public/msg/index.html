<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLSC Messenger</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;background:#0a0a0a;min-height:100vh;color:#fff}
        .app{display:flex;height:100vh}
        .sidebar{width:320px;background:#111;border-right:1px solid rgba(255,255,255,0.1);display:flex;flex-direction:column}
        .sidebar-header{padding:20px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:space-between}
        .sidebar-header h2{font-size:18px;display:flex;align-items:center;gap:10px}
        .sidebar-header h2 span{color:#3fb950}
        .new-chat-btn{background:#3fb950;border:none;color:#000;padding:8px 16px;border-radius:20px;font-weight:600;cursor:pointer;font-size:13px}
        .search-box{padding:15px}
        .search-box input{width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:25px;color:#fff;font-size:14px}
        .search-box input:focus{outline:none;border-color:#3fb950}
        .conversations{flex:1;overflow-y:auto}
        .conv-item{display:flex;align-items:center;gap:12px;padding:15px 20px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.05);transition:background 0.2s}
        .conv-item:hover,.conv-item.active{background:rgba(63,185,80,0.1)}
        .conv-avatar{width:45px;height:45px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:16px}
        .conv-info{flex:1;min-width:0}
        .conv-name{font-weight:600;font-size:14px;margin-bottom:4px}
        .conv-preview{font-size:12px;color:rgba(255,255,255,0.5);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .conv-time{font-size:11px;color:rgba(255,255,255,0.4)}
        .conv-unread{background:#3fb950;color:#000;font-size:11px;font-weight:700;padding:2px 8px;border-radius:10px;margin-top:5px;display:inline-block}
        .chat-area{flex:1;display:flex;flex-direction:column;background:#0a0a0a}
        .chat-header{padding:15px 25px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;gap:15px}
        .chat-header-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600}
        .chat-header-info h3{font-size:16px;margin-bottom:2px}
        .chat-header-info p{font-size:12px;color:#3fb950}
        .messages{flex:1;overflow-y:auto;padding:20px}
        .message{display:flex;margin-bottom:15px;gap:10px}
        .message.sent{flex-direction:row-reverse}
        .msg-avatar{width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;flex-shrink:0}
        .msg-content{max-width:65%}
        .msg-bubble{padding:12px 16px;border-radius:18px;font-size:14px;line-height:1.5}
        .message.received .msg-bubble{background:rgba(255,255,255,0.1);border-bottom-left-radius:4px}
        .message.sent .msg-bubble{background:#3fb950;color:#000;border-bottom-right-radius:4px}
        .msg-time{font-size:11px;color:rgba(255,255,255,0.4);margin-top:5px;padding:0 5px}
        .message.sent .msg-time{text-align:right}
        .msg-file{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:12px;margin-top:8px;display:flex;align-items:center;gap:10px}
        .msg-file-icon{font-size:24px}
        .msg-file-info{flex:1}
        .msg-file-name{font-size:13px;font-weight:500}
        .msg-file-size{font-size:11px;color:rgba(255,255,255,0.5)}
        .msg-file-download{background:#3fb950;color:#000;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600}
    </style>
</head>
<body>
<style>

    .chat-input{padding:15px 25px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:12px;align-items:flex-end}
    .chat-input-box{flex:1;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:25px;padding:12px 20px;display:flex;align-items:center;gap:10px}
    .chat-input-box textarea{flex:1;background:none;border:none;color:#fff;font-size:14px;resize:none;max-height:100px;font-family:inherit}
    .chat-input-box textarea:focus{outline:none}
    .attach-btn{background:none;border:none;cursor:pointer;font-size:20px;padding:8px}
    .send-btn{background:#3fb950;border:none;border-radius:50%;width:45px;height:45px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px}
    .empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:rgba(255,255,255,0.5)}
    .empty-state .icon{font-size:80px;margin-bottom:20px}
    .empty-state h3{font-size:20px;margin-bottom:10px;color:#fff}
    .login-required{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:1000}
    .login-box{background:#111;border:1px solid rgba(63,185,80,0.3);border-radius:20px;padding:40px;text-align:center;max-width:400px}
    .login-box .icon{font-size:60px;margin-bottom:20px}
    .login-box h2{margin-bottom:10px}
    .login-box p{color:rgba(255,255,255,0.5);margin-bottom:25px}
    .login-box a{display:inline-block;background:#3fb950;color:#000;padding:14px 40px;border-radius:25px;text-decoration:none;font-weight:600}
    .new-chat-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:1000}
    .new-chat-modal.show{display:flex}
    .modal-content{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:30px;width:400px;max-width:90%}
    .modal-content h3{margin-bottom:20px}
    .modal-content input,.modal-content textarea{width:100%;padding:14px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;font-size:14px;margin-bottom:15px}
    .modal-content input:focus,.modal-content textarea:focus{outline:none;border-color:#3fb950}
    .modal-btns{display:flex;gap:10px;margin-top:10px}
    .modal-btns button{flex:1;padding:14px;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;border:none}
    .modal-btns .cancel{background:rgba(255,255,255,0.1);color:#fff}
    .modal-btns .send{background:#3fb950;color:#000}
    .user-list{max-height:200px;overflow-y:auto;margin-bottom:15px}
    .user-option{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;cursor:pointer}
    .user-option:hover,.user-option.selected{background:rgba(63,185,80,0.2)}
    .user-option-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600}
    @media(max-width:768px){.sidebar{width:100%;position:absolute;z-index:10}.chat-area{width:100%}.sidebar.hidden{display:none}}
</style>

<div class="login-required" id="loginRequired" style="display:none">
    <div class="login-box">
        <div class="icon">üí¨</div>
        <h2>BLSC Messenger</h2>
        <p>Sign in to send and receive messages</p>
        <a href="../../../auth.html">Sign In / Create Account</a>
    </div>
</div>

<div class="app" id="mainApp">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>üí¨ <span>Messages</span></h2>
            <button class="new-chat-btn" onclick="showNewChatModal()">+ New</button>
        </div>
        <div class="search-box"><input type="text" placeholder="Search..." id="searchConv" oninput="filterConversations()"></div>
        <div class="conversations" id="conversationsList"></div>
    </div>
    
    <div class="chat-area" id="chatArea">
        <div class="empty-state" id="emptyState">
            <div class="icon">üí¨</div>
            <h3>Select a conversation</h3>
            <p>Choose from existing or start new</p>
        </div>
        
        <div id="activeChat" style="display:none;flex-direction:column;height:100%">
            <div class="chat-header">
                <div class="chat-header-avatar" id="chatAvatar"></div>
                <div class="chat-header-info"><h3 id="chatName"></h3><p id="chatStatus">Online</p></div>
            </div>
            <div class="messages" id="messagesList"></div>
            <div class="chat-input">
                <div class="chat-input-box">
                    <button class="attach-btn" onclick="document.getElementById('fileInput').click()">üìé</button>
                    <input type="file" id="fileInput" style="display:none" onchange="handleFileSelect(this)">
                    <textarea id="messageInput" placeholder="Type a message..." rows="1" oninput="toggleSendBtn()" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
                </div>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">‚û§</button>
            </div>
        </div>
    </div>
</div>

<div class="new-chat-modal" id="newChatModal">
    <div class="modal-content">
        <h3>‚úâÔ∏è New Message</h3>
        <input type="text" id="searchUser" placeholder="Search user by email..." oninput="searchUsers()">
        <div class="user-list" id="userList"></div>
        <textarea id="newMessage" placeholder="Write your message..." rows="3"></textarea>
        <div class="modal-btns">
            <button class="cancel" onclick="closeNewChatModal()">Cancel</button>
            <button class="send" onclick="startNewChat()">Send</button>
        </div>
    </div>
</div>

<script src="../../../blsc-account.js"></script>
<script>
    // State variables
    let currentUser = null;
    let allUsers = {};
    let conversations = [];
    let activeConversation = null;
    let selectedRecipient = null;
    let pendingFile = null;

    // Initialize app
    async function init() {
        if (!BLSC_ACCOUNT.isLoggedIn()) {
            document.getElementById('loginRequired').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            return;
        }
        currentUser = BLSC_ACCOUNT.getCurrentUser();
        allUsers = await BLSC_ACCOUNT.getUsers();
        await loadConversations();
        renderConversations();
        
        // Auto-refresh every 2 seconds (fast sync)
        setInterval(async () => {
            await loadConversations();
            renderConversations();
            if (activeConversation) renderMessages();
        }, 2000);
    }
    init();

    // Load conversations from cloud
    async function loadConversations() {
        const users = await BLSC_ACCOUNT.getUsers();
        allUsers = users;
        const userData = users[currentUser.email];
        conversations = userData?.messages || [];
    }

    // Save conversations to cloud
    async function saveConversations() {
        const users = await BLSC_ACCOUNT.getUsers();
        if (!users[currentUser.email].messages) users[currentUser.email].messages = [];
        users[currentUser.email].messages = conversations;
        await BLSC_ACCOUNT.saveUsers(users);
    }

    // Render conversation list
    function renderConversations() {
        const list = document.getElementById('conversationsList');
        const search = document.getElementById('searchConv').value.toLowerCase();
        const convMap = {};
        
        conversations.forEach(msg => {
            const partner = msg.from === currentUser.email ? msg.to : msg.from;
            if (!convMap[partner]) convMap[partner] = [];
            convMap[partner].push(msg);
        });
        
        const sorted = Object.entries(convMap).sort((a, b) => 
            new Date(b[1][b[1].length - 1].time) - new Date(a[1][a[1].length - 1].time)
        );
        
        if (!sorted.length) {
            list.innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.4)"><p>No conversations</p><p style="font-size:12px;margin-top:10px">Click "+ New" to start</p></div>';
            return;
        }
        
        list.innerHTML = sorted.filter(([email]) => email.toLowerCase().includes(search)).map(([email, msgs]) => {
            const partner = allUsers[email] || { name: email, email };
            const lastMsg = msgs[msgs.length - 1];
            const unread = msgs.filter(m => m.from !== currentUser.email && !m.read).length;
            const color = BLSC_ACCOUNT.getAvatarColor(partner.name || email);
            const initials = BLSC_ACCOUNT.getInitials(partner.name || email);
            const preview = lastMsg.file ? 'üìé ' + lastMsg.file.name : lastMsg.text;
            
            return `<div class="conv-item ${activeConversation === email ? 'active' : ''}" onclick="openConversation('${email}')">
                <div class="conv-avatar" style="background:${color}">${initials}</div>
                <div class="conv-info">
                    <div class="conv-name">${partner.name || email}</div>
                    <div class="conv-preview">${preview}</div>
                </div>
                <div class="conv-meta">
                    <div class="conv-time">${formatTime(lastMsg.time)}</div>
                    ${unread > 0 ? `<div class="conv-unread">${unread}</div>` : ''}
                </div>
            </div>`;
        }).join('');
    }

    // Open a conversation
    function openConversation(email) {
        activeConversation = email;
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('activeChat').style.display = 'flex';
        
        const partner = allUsers[email] || { name: email, email };
        const color = BLSC_ACCOUNT.getAvatarColor(partner.name || email);
        const initials = BLSC_ACCOUNT.getInitials(partner.name || email);
        
        document.getElementById('chatAvatar').style.background = color;
        document.getElementById('chatAvatar').textContent = initials;
        document.getElementById('chatName').textContent = partner.name || email;
        
        // Mark messages as read
        conversations.forEach(m => {
            if ((m.from === email || m.to === email) && m.from !== currentUser.email) m.read = true;
        });
        
        saveConversations();
        renderConversations();
        renderMessages();
    }

    // Render messages in chat
    function renderMessages() {
        const list = document.getElementById('messagesList');
        const msgs = conversations.filter(m => m.from === activeConversation || m.to === activeConversation);
        
        list.innerHTML = msgs.map(m => {
            const isSent = m.from === currentUser.email;
            const sender = allUsers[m.from] || { name: m.from };
            const color = BLSC_ACCOUNT.getAvatarColor(sender.name || m.from);
            const initials = BLSC_ACCOUNT.getInitials(sender.name || m.from);
            
            let fileHtml = '';
            if (m.file) {
                fileHtml = `<div class="msg-file">
                    <div class="msg-file-icon">${getFileIcon(m.file.name)}</div>
                    <div class="msg-file-info">
                        <div class="msg-file-name">${m.file.name}</div>
                        <div class="msg-file-size">${formatSize(m.file.size)}</div>
                    </div>
                    <button class="msg-file-download" onclick="downloadFile('${m.file.data}','${m.file.name}')">Download</button>
                </div>`;
            }
            
            return `<div class="message ${isSent ? 'sent' : 'received'}">
                <div class="msg-avatar" style="background:${color}">${initials}</div>
                <div class="msg-content">
                    ${m.text ? `<div class="msg-bubble">${escapeHtml(m.text)}</div>` : ''}
                    ${fileHtml}
                    <div class="msg-time">${formatTime(m.time)}</div>
                </div>
            </div>`;
        }).join('');
        
        list.scrollTop = list.scrollHeight;
    }

    // Send a message
    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        
        if (!text && !pendingFile) return;
        if (!activeConversation) return;
        
        const msg = {
            id: 'msg_' + Date.now(),
            from: currentUser.email,
            to: activeConversation,
            text: text,
            time: new Date().toISOString(),
            read: false
        };
        
        if (pendingFile) {
            msg.file = pendingFile;
            pendingFile = null;
        }
        
        conversations.push(msg);
        await saveConversations();
        
        // Also save to recipient's messages
        const users = await BLSC_ACCOUNT.getUsers();
        if (users[activeConversation]) {
            if (!users[activeConversation].messages) users[activeConversation].messages = [];
            users[activeConversation].messages.push(msg);
            await BLSC_ACCOUNT.saveUsers(users);
        }
        
        input.value = '';
        renderMessages();
        renderConversations();
    }

    // Handle file selection
    function handleFileSelect(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        
        if (file.size > 2 * 1024 * 1024) {
            alert('Max 2MB');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            pendingFile = {
                name: file.name,
                size: file.size,
                type: file.type,
                data: e.target.result
            };
            document.getElementById('messageInput').value = 'üìé ' + file.name;
            toggleSendBtn();
        };
        reader.readAsDataURL(file);
    }

    // Download file
    function downloadFile(data, name) {
        const a = document.createElement('a');
        a.href = data;
        a.download = name;
        a.click();
    }

    // New chat modal functions
    function showNewChatModal() {
        document.getElementById('newChatModal').classList.add('show');
        searchUsers();
    }

    function closeNewChatModal() {
        document.getElementById('newChatModal').classList.remove('show');
        selectedRecipient = null;
        document.getElementById('searchUser').value = '';
        document.getElementById('newMessage').value = '';
    }

    // Search users for new chat
    function searchUsers() {
        const search = document.getElementById('searchUser').value.toLowerCase();
        const list = document.getElementById('userList');
        
        const users = Object.values(allUsers).filter(u => 
            u.email && u.email !== currentUser.email && 
            (u.email.toLowerCase().includes(search) || (u.name || '').toLowerCase().includes(search))
        );
        
        if (!users.length) {
            list.innerHTML = '<div style="padding:20px;text-align:center;color:rgba(255,255,255,0.4)">No users found</div>';
            return;
        }
        
        list.innerHTML = users.slice(0, 10).map(u => {
            const color = BLSC_ACCOUNT.getAvatarColor(u.name || u.email);
            const initials = BLSC_ACCOUNT.getInitials(u.name || u.email);
            
            return `<div class="user-option ${selectedRecipient === u.email ? 'selected' : ''}" onclick="selectRecipient('${u.email}')">
                <div class="user-option-avatar" style="background:${color}">${initials}</div>
                <div>
                    <div style="font-weight:600">${u.name || 'Unknown'}</div>
                    <div style="font-size:12px;color:rgba(255,255,255,0.5)">${u.email}</div>
                </div>
            </div>`;
        }).join('');
    }

    // Select recipient for new chat
    function selectRecipient(email) {
        selectedRecipient = email;
        searchUsers();
    }

    // Start new chat
    async function startNewChat() {
        if (!selectedRecipient) {
            alert('Select a user');
            return;
        }
        
        const text = document.getElementById('newMessage').value.trim();
        if (!text) {
            alert('Enter a message');
            return;
        }
        
        const msg = {
            id: 'msg_' + Date.now(),
            from: currentUser.email,
            to: selectedRecipient,
            text: text,
            time: new Date().toISOString(),
            read: false
        };
        
        conversations.push(msg);
        await saveConversations();
        
        // Also save to recipient's messages
        const users = await BLSC_ACCOUNT.getUsers();
        if (users[selectedRecipient]) {
            if (!users[selectedRecipient].messages) users[selectedRecipient].messages = [];
            users[selectedRecipient].messages.push(msg);
            await BLSC_ACCOUNT.saveUsers(users);
        }
        
        closeNewChatModal();
        renderConversations();
        openConversation(selectedRecipient);
    }

    // Utility functions
    function formatTime(iso) {
        const d = new Date(iso);
        const now = new Date();
        if (d.toDateString() === now.toDateString()) {
            return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        return d.toLocaleDateString();
    }

    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function getFileIcon(name) {
        const ext = name.split('.').pop().toLowerCase();
        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return 'üñºÔ∏è';
        if (['mp4', 'mov', 'avi'].includes(ext)) return 'üé¨';
        if (['mp3', 'wav'].includes(ext)) return 'üéµ';
        if (['pdf'].includes(ext)) return 'üìÑ';
        return 'üìÅ';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function filterConversations() {
        renderConversations();
    }
</script>
</body>
</html>