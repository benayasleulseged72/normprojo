<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLSC Admin Panel</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;background:#0a0a0a;min-height:100vh;color:#fff}
        .bg-gradient{position:fixed;top:0;left:0;right:0;bottom:0;background:radial-gradient(circle at 20% 20%,rgba(63,185,80,0.15) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(88,166,255,0.1) 0%,transparent 50%),#0a0a0a;z-index:-1}
        .login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
        .login-box{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:24px;padding:40px;width:100%;max-width:400px;text-align:center}
        .login-box h1{font-size:28px;margin-bottom:8px}
        .login-box h1 span{color:#3fb950}
        .login-box p{color:rgba(255,255,255,0.5);margin-bottom:30px;font-size:14px}
        .login-box .icon{font-size:60px;margin-bottom:20px}
        .form-group{margin-bottom:20px;text-align:left}
        .form-group label{display:block;color:rgba(255,255,255,0.7);font-size:14px;margin-bottom:8px}
        .form-group input{width:100%;padding:14px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;font-size:15px}
        .form-group input:focus{outline:none;border-color:#3fb950}
        .login-btn{width:100%;padding:16px;background:linear-gradient(135deg,#3fb950,#2ea043);border:none;border-radius:12px;color:#fff;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s}
        .login-btn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(63,185,80,0.3)}
        .error-msg{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#ef4444;padding:12px;border-radius:10px;margin-bottom:20px;font-size:14px;display:none}
        .admin-panel{display:none;padding:20px;max-width:1400px;margin:0 auto}
        .admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:20px}
        .admin-header h1{font-size:28px}
        .admin-header h1 span{color:#3fb950}
        .logout-btn{padding:12px 24px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:100px;color:#ef4444;font-size:14px;cursor:pointer;transition:all 0.3s}
        .logout-btn:hover{background:rgba(239,68,68,0.2)}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
        .stat-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px;text-align:center}
        .stat-card .number{font-size:42px;font-weight:800;color:#3fb950}
        .stat-card .label{color:rgba(255,255,255,0.5);font-size:14px;margin-top:8px}
        .tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
        .tab{padding:12px 24px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:100px;color:rgba(255,255,255,0.7);font-size:14px;cursor:pointer;transition:all 0.3s}
        .tab:hover{background:rgba(255,255,255,0.1)}
        .tab.active{background:#3fb950;color:#000;border-color:#3fb950}
        .content-panel{display:none}
        .content-panel.active{display:block}
        .users-table{width:100%;border-collapse:collapse;background:rgba(255,255,255,0.03);border-radius:16px;overflow:hidden}
        .users-table th,.users-table td{padding:16px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.05)}
        .users-table th{background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.7);font-weight:600;font-size:13px;text-transform:uppercase}
        .users-table td{font-size:14px}
        .users-table tr:hover{background:rgba(255,255,255,0.02)}
        .user-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:14px}
        .user-info{display:flex;align-items:center;gap:12px}
        .user-name{font-weight:600}
        .user-email{color:rgba(255,255,255,0.5);font-size:13px}
        .badge{padding:4px 12px;border-radius:100px;font-size:12px;font-weight:600}
        .badge.active{background:rgba(63,185,80,0.15);color:#3fb950}
        .badge.expired{background:rgba(239,68,68,0.15);color:#ef4444}
        .badge.none{background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.5)}
        .action-btn{padding:8px 16px;border-radius:8px;font-size:13px;cursor:pointer;transition:all 0.3s;margin-right:8px;border:none}
        .action-btn.primary{background:#3fb950;color:#000}
        .action-btn.danger{background:rgba(239,68,68,0.2);color:#ef4444}
        .action-btn:hover{transform:scale(1.05)}
        .sub-form{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px;margin-bottom:24px}
        .sub-form h3{margin-bottom:20px;font-size:18px}
        .sub-form .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:16px}
        .sub-form select{width:100%;padding:14px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;font-size:15px}
        .sub-form select option{background:#1a1a1a}
        .search-box{margin-bottom:20px}
        .search-box input{width:100%;max-width:400px;padding:14px 20px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:100px;color:#fff;font-size:15px}
        .search-box input:focus{outline:none;border-color:#3fb950}
        @media(max-width:768px){.users-table{display:block;overflow-x:auto}.admin-header{flex-direction:column;text-align:center}}
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="icon">üîê</div>
            <h1>BLSC <span>Admin</span></h1>
            <p>Enter admin credentials to access the control panel</p>
            <div class="error-msg" id="errorMsg">Invalid credentials</div>
            <form onsubmit="adminLogin(event)">
                <div class="form-group">
                    <label>Username / Email</label>
                    <input type="text" id="adminUser" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="adminPass" placeholder="Enter password" required>
                </div>
                <button type="submit" class="login-btn">üîì Login to Admin Panel</button>
            </form>
        </div>
    </div>
</body>
</html>
<!--
 This is a redirect file - the full admin panel continues below -->
<script>
// Redirect to main admin or load inline
</script>

<!-- Admin Panel HTML inserted before closing body -->
<div class="admin-panel" id="adminPanel">
    <!-- System Status Bar -->
    <div id="systemStatus" style="display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:rgba(63,185,80,0.1);border:1px solid rgba(63,185,80,0.3);border-radius:12px;margin-bottom:20px">
        <div style="display:flex;align-items:center;gap:10px">
            <div id="statusDot" style="width:12px;height:12px;border-radius:50%;background:#3fb950;animation:pulse 2s infinite"></div>
            <span id="statusText" style="color:#3fb950;font-weight:600">üü¢ SYSTEM ONLINE</span>
        </div>
        <div style="display:flex;align-items:center;gap:20px;font-size:13px;color:rgba(255,255,255,0.6)">
            <span>‚òÅÔ∏è Cloud: <span id="cloudStatus" style="color:#3fb950">Connected</span></span>
            <span>üïê Last Sync: <span id="lastSync">--:--</span></span>
            <span>üì° Ping: <span id="pingTime" style="color:#3fb950">--ms</span></span>
        </div>
    </div>
    <style>
        @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(1.2)}}
        .status-offline{background:rgba(239,68,68,0.1)!important;border-color:rgba(239,68,68,0.3)!important}
        .status-offline #statusDot{background:#ef4444!important}
        .status-offline #statusText{color:#ef4444!important}
    </style>
    
    <div class="admin-header">
        <h1>üõ°Ô∏è BLSC <span>Admin Panel</span></h1>
        <button class="logout-btn" onclick="adminLogout()">üö™ Logout</button>
    </div>
    <div class="stats-grid">
        <div class="stat-card"><div class="number" id="totalUsers">0</div><div class="label">Total Users</div></div>
        <div class="stat-card"><div class="number" id="activeTrials">0</div><div class="label">Active Trials</div></div>
        <div class="stat-card"><div class="number" id="paidSubs">0</div><div class="label">Paid Subscriptions</div></div>
        <div class="stat-card"><div class="number" id="pendingPay">0</div><div class="label">Pending Payments</div></div>
        <div class="stat-card" style="border-color:rgba(239,68,68,0.3)"><div class="number" id="bannedUsers" style="color:#ef4444">0</div><div class="label">Banned Users</div></div>
    </div>
    <div class="tabs">
        <button class="tab active" onclick="showTab('users')">üë• All Users</button>
        <button class="tab" onclick="showTab('payments')">üí∞ Pending Payments</button>
        <button class="tab" onclick="showTab('subscriptions')">üí≥ Manage Subscriptions</button>
        <button class="tab" onclick="showTab('coupons')">üéüÔ∏è Coupon Codes</button>
        <button class="tab" onclick="showTab('banned')">üö´ Banned Users</button>
        <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
    </div>
    <div class="content-panel active" id="usersPanel">
        <div class="search-box"><input type="text" id="searchUsers" placeholder="üîç Search users..." oninput="filterUsers()"></div>
        <table class="users-table">
            <thead><tr><th>User</th><th>Created</th><th>Last Login</th><th>Subscriptions</th><th>Actions</th></tr></thead>
            <tbody id="usersTableBody"><tr><td colspan="5" style="text-align:center;padding:40px">Loading...</td></tr></tbody>
        </table>
    </div>
    <div class="content-panel" id="paymentsPanel">
        <h3 style="margin-bottom:20px">üí∞ Pending Payment Requests</h3>
        <table class="users-table">
            <thead><tr><th>User</th><th>Service</th><th>Plan</th><th>Amount</th><th>Method</th><th>Screenshot</th><th>Date</th><th>Actions</th></tr></thead>
            <tbody id="paymentsTableBody"><tr><td colspan="8" style="text-align:center;padding:40px">Loading...</td></tr></tbody>
        </table>
    </div>
    <div id="screenshotModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:9999;align-items:center;justify-content:center">
        <div style="max-width:90%;max-height:90%;position:relative">
            <button onclick="closeScreenshot()" style="position:absolute;top:-40px;right:0;background:#ef4444;border:none;color:#fff;padding:10px 20px;border-radius:8px;cursor:pointer">‚úï Close</button>
            <img id="modalScreenshot" style="max-width:100%;max-height:80vh;border-radius:12px;border:2px solid #3fb950">
        </div>
    </div>
    <div class="content-panel" id="subscriptionsPanel">
        <div class="sub-form">
            <h3>‚ûï Add/Update Subscription</h3>
            <div class="form-row">
                <div class="form-group"><label>User Email</label><input type="email" id="subEmail" placeholder="user@email.com"></div>
                <div class="form-group"><label>Service</label><select id="subService"><option value="images">üîç Image Stock</option><option value="ai-image">üé® Image Generator</option><option value="ai-video">üé¨ Video Generator</option></select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Plan Type</label><select id="subType"><option value="free_trial">Free Trial (30 days)</option><option value="monthly">Monthly (30 days)</option><option value="yearly">Yearly (365 days)</option><option value="unlimited">Unlimited (Forever)</option></select></div>
                <div class="form-group"><label>&nbsp;</label><button class="action-btn primary" style="width:100%;padding:14px" onclick="addSubscription()">‚úÖ Activate Subscription</button></div>
            </div>
        </div>
        <h3 style="margin-bottom:16px">üìã All Subscriptions</h3>
        <table class="users-table">
            <thead><tr><th>User</th><th>Service</th><th>Type</th><th>Status</th><th>Expires</th><th>Actions</th></tr></thead>
            <tbody id="subsTableBody"><tr><td colspan="6" style="text-align:center;padding:40px">Loading...</td></tr></tbody>
        </table>
    </div>
    <div class="content-panel" id="couponsPanel">
        <div class="sub-form">
            <h3>üéüÔ∏è Generate Coupon Code</h3>
            <div class="form-row">
                <div class="form-group"><label>Service</label><select id="couponService"><option value="images">üîç Image Stock</option><option value="ai-image">üé® Image Generator</option><option value="ai-video">üé¨ Video Generator</option></select></div>
                <div class="form-group"><label>Plan Type</label><select id="couponType"><option value="monthly">Monthly (30 days)</option><option value="yearly">Yearly (365 days)</option><option value="unlimited">Unlimited (Forever)</option></select></div>
            </div>
            <button class="action-btn primary" style="padding:14px 30px" onclick="generateCoupon()">üé´ Generate New Coupon</button>
        </div>
        <h3 style="margin-bottom:16px">üìã Active Coupons</h3>
        <table class="users-table">
            <thead><tr><th>Code</th><th>Service</th><th>Plan</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead>
            <tbody id="couponsTableBody"><tr><td colspan="6" style="text-align:center;padding:40px">Loading...</td></tr></tbody>
        </table>
    </div>
    <div class="content-panel" id="bannedPanel">
        <h3 style="margin-bottom:20px;color:#ef4444">üö´ Banned Users</h3>
        <table class="users-table">
            <thead><tr><th>User</th><th>Email</th><th>Banned Date</th><th>Reason</th><th>Actions</th></tr></thead>
            <tbody id="bannedTableBody"><tr><td colspan="5" style="text-align:center;padding:40px">No banned users</td></tr></tbody>
        </table>
    </div>
    <div class="content-panel" id="settingsPanel">
        <div class="sub-form">
            <h3>‚öôÔ∏è Admin Settings</h3>
            <p style="color:rgba(255,255,255,0.5);margin-bottom:20px">Manage admin account and system settings</p>
            <div class="form-group"><label>JSONBin.io Bin ID</label><input type="text" id="binId" value="" disabled style="opacity:0.5"></div>
            <button class="action-btn primary" onclick="refreshData()" style="margin-top:10px">üîÑ Refresh All Data</button>
            <button class="action-btn danger" onclick="exportAllData()" style="margin-top:10px">üì• Export All Data</button>
        </div>
    </div>
</div>

<script src="../blsc-account.js"></script>

<script>
const ADMIN_USER = 'support@blsc.com';
const ADMIN_PASS = '1xvbeni72';
const ADMIN_SESSION_KEY = 'blsc_admin_session';
let allUsers = {};

function checkAdminSession() {
    if (localStorage.getItem(ADMIN_SESSION_KEY) === 'logged_in') showAdminPanel();
}
checkAdminSession();

function adminLogin(e) {
    e.preventDefault();
    const user = document.getElementById('adminUser').value;
    const pass = document.getElementById('adminPass').value;
    if ((user === ADMIN_USER || user === 'admin') && pass === ADMIN_PASS) {
        localStorage.setItem(ADMIN_SESSION_KEY, 'logged_in');
        showAdminPanel();
    } else {
        document.getElementById('errorMsg').style.display = 'block';
        setTimeout(() => document.getElementById('errorMsg').style.display = 'none', 3000);
    }
}

function adminLogout() {
    localStorage.removeItem(ADMIN_SESSION_KEY);
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('adminPanel').style.display = 'none';
}

async function showAdminPanel() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    document.getElementById('binId').value = BLSC_ACCOUNT.JSONBIN_BIN_ID;
    await loadAllData();
}

async function loadAllData() {
    try {
        allUsers = await BLSC_ACCOUNT.getUsers();
        updateStats();
        renderUsersTable();
        renderSubscriptionsTable();
        renderPaymentsTable();
        renderCouponsTable();
        renderBannedTable();
    } catch (error) { console.error('Error:', error); }
}

function updateStats() {
    const userList = Object.values(allUsers).filter(u => typeof u === 'object' && u.email);
    let activeTrials = 0, paidSubs = 0, pendingPay = 0, bannedCount = 0;
    userList.forEach(user => {
        if (user.banned) { bannedCount++; return; }
        if (user.subscriptions) {
            Object.values(user.subscriptions).forEach(sub => {
                if (sub.type === 'unlimited' || new Date() < new Date(sub.endDate)) {
                    if (sub.type === 'free_trial') activeTrials++;
                    else paidSubs++;
                }
            });
        }
        if (user.pendingPayments) pendingPay += user.pendingPayments.filter(p => p.status === 'pending').length;
    });
    document.getElementById('totalUsers').textContent = userList.filter(u => !u.banned).length;
    document.getElementById('activeTrials').textContent = activeTrials;
    document.getElementById('paidSubs').textContent = paidSubs;
    document.getElementById('pendingPay').textContent = pendingPay;
    document.getElementById('bannedUsers').textContent = bannedCount;
}

function renderUsersTable(filter = '') {
    const tbody = document.getElementById('usersTableBody');
    const userList = Object.values(allUsers).filter(u => !u.banned);
    if (userList.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px">No users</td></tr>'; return; }
    const filtered = filter ? userList.filter(u => u.name.toLowerCase().includes(filter.toLowerCase()) || u.email.toLowerCase().includes(filter.toLowerCase())) : userList;
    tbody.innerHTML = filtered.map(user => {
        const color = BLSC_ACCOUNT.getAvatarColor(user.name);
        const initials = BLSC_ACCOUNT.getInitials(user.name);
        const subs = user.subscriptions ? Object.keys(user.subscriptions).length : 0;
        return `<tr><td><div class="user-info"><div class="user-avatar" style="background:${color}">${initials}</div><div><div class="user-name">${user.name}</div><div class="user-email">${user.email}</div></div></div></td><td>${new Date(user.createdAt).toLocaleDateString()}</td><td>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}</td><td><span class="badge ${subs > 0 ? 'active' : 'none'}">${subs} service(s)</span></td><td><button class="action-btn primary" onclick="editUser('${user.email}')">‚úèÔ∏è</button><button class="action-btn" style="background:#ff6b00;color:#fff" onclick="banUser('${user.email}')">üî® BAN</button><button class="action-btn danger" onclick="deleteUser('${user.email}')">üóëÔ∏è</button></td></tr>`;
    }).join('');
}

function renderSubscriptionsTable() {
    const tbody = document.getElementById('subsTableBody');
    const rows = [];
    const serviceNames = {'images':'üîç Image Stock','ai-image':'üé® Image Generator','ai-video':'üé¨ Video Generator'};
    Object.values(allUsers).forEach(user => {
        if (user.subscriptions) {
            Object.entries(user.subscriptions).forEach(([service, sub]) => {
                const isActive = sub.type === 'unlimited' || new Date() < new Date(sub.endDate);
                rows.push(`<tr><td>${user.email}</td><td>${serviceNames[service] || service}</td><td>${sub.type}</td><td><span class="badge ${isActive ? 'active' : 'expired'}">${isActive ? 'Active' : 'Expired'}</span></td><td>${sub.endDate ? new Date(sub.endDate).toLocaleDateString() : 'Never'}</td><td><button class="action-btn danger" onclick="removeSub('${user.email}','${service}')">üóëÔ∏è</button></td></tr>`);
            });
        }
    });
    tbody.innerHTML = rows.length > 0 ? rows.join('') : '<tr><td colspan="6" style="text-align:center;padding:40px">No subscriptions</td></tr>';
}

function renderPaymentsTable() {
    const tbody = document.getElementById('paymentsTableBody');
    const rows = [];
    const serviceNames = {'images':'üîç Image Stock','ai-image':'üé® Image Generator','ai-video':'üé¨ Video Generator'};
    Object.values(allUsers).forEach(user => {
        if (user.pendingPayments) {
            user.pendingPayments.forEach((payment, index) => {
                if (payment.status === 'pending') {
                    const screenshot = payment.screenshotUrl ? `<button class="action-btn" style="background:#58a6ff;color:#fff" onclick="viewScreenshot('${payment.screenshotUrl.substring(0,100)}...')">üì∑ View</button>` : 'No image';
                    rows.push(`<tr><td>${user.email}</td><td>${serviceNames[payment.service] || payment.service}</td><td>${payment.plan}</td><td><strong>${payment.amount} Birr</strong></td><td>${payment.method}</td><td><button class="action-btn" style="background:#58a6ff;color:#fff" onclick="viewScreenshotFull('${user.email}',${index})">üì∑ View</button></td><td>${new Date(payment.createdAt).toLocaleDateString()}</td><td><button class="action-btn primary" onclick="approvePayment('${user.email}',${index})">‚úÖ</button><button class="action-btn danger" onclick="rejectPayment('${user.email}',${index})">‚ùå</button></td></tr>`);
                }
            });
        }
    });
    tbody.innerHTML = rows.length > 0 ? rows.join('') : '<tr><td colspan="8" style="text-align:center;padding:40px">No pending payments</td></tr>';
}

function viewScreenshotFull(email, index) {
    const user = allUsers[email];
    if (user && user.pendingPayments && user.pendingPayments[index]) {
        const url = user.pendingPayments[index].screenshotUrl;
        if (url) {
            document.getElementById('modalScreenshot').src = url;
            document.getElementById('screenshotModal').style.display = 'flex';
        }
    }
}

function closeScreenshot() { document.getElementById('screenshotModal').style.display = 'none'; }
document.getElementById('screenshotModal')?.addEventListener('click', function(e) { if (e.target === this) closeScreenshot(); });

function filterUsers() { renderUsersTable(document.getElementById('searchUsers').value); }
function showTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tab + 'Panel').classList.add('active');
}

async function addSubscription() {
    const email = document.getElementById('subEmail').value;
    const service = document.getElementById('subService').value;
    const type = document.getElementById('subType').value;
    if (!email) { alert('Enter user email'); return; }
    if (!allUsers[email]) { alert('User not found: ' + email); return; }
    const days = {'free_trial':30,'monthly':30,'yearly':365,'unlimited':0};
    const result = await BLSC_ACCOUNT.activateSubscription(email, service, type, days[type]);
    if (result) { alert('‚úÖ Subscription activated!'); await loadAllData(); }
}

async function removeSub(email, service) {
    if (!confirm('Remove subscription?')) return;
    const users = await BLSC_ACCOUNT.getUsers();
    if (users[email]?.subscriptions) { delete users[email].subscriptions[service]; await BLSC_ACCOUNT.saveUsers(users); alert('‚úÖ Removed'); await loadAllData(); }
}

async function deleteUser(email) {
    if (!confirm('Delete user ' + email + '?')) return;
    const users = await BLSC_ACCOUNT.getUsers();
    delete users[email];
    await BLSC_ACCOUNT.saveUsers(users);
    alert('‚úÖ Deleted');
    await loadAllData();
}

function editUser(email) {
    document.getElementById('subEmail').value = email;
    showTab('subscriptions');
}

async function approvePayment(email, index) {
    const users = await BLSC_ACCOUNT.getUsers();
    const payment = users[email].pendingPayments[index];
    if (!confirm(`Approve ${payment.amount} Birr from ${email}?`)) return;
    const days = {'monthly':30,'yearly':365,'unlimited':0};
    await BLSC_ACCOUNT.activateSubscription(email, payment.service, payment.plan, days[payment.plan]);
    users[email].pendingPayments[index].status = 'approved';
    users[email].pendingPayments[index].approvedAt = new Date().toISOString();
    await BLSC_ACCOUNT.saveUsers(users);
    alert('‚úÖ Approved!');
    await loadAllData();
}

async function rejectPayment(email, index) {
    if (!confirm('Reject payment?')) return;
    const users = await BLSC_ACCOUNT.getUsers();
    users[email].pendingPayments[index].status = 'rejected';
    await BLSC_ACCOUNT.saveUsers(users);
    alert('‚ùå Rejected');
    await loadAllData();
}

// Coupon system
async function generateCoupon() {
    const service = document.getElementById('couponService').value;
    const type = document.getElementById('couponType').value;
    const code = 'BLSC-' + Math.random().toString(36).substring(2, 8).toUpperCase();
    const users = await BLSC_ACCOUNT.getUsers();
    if (!users._coupons) users._coupons = [];
    users._coupons.push({ code, service, type, status: 'active', createdAt: new Date().toISOString() });
    await BLSC_ACCOUNT.saveUsers(users);
    alert('‚úÖ Coupon created: ' + code);
    await loadAllData();
}

function renderCouponsTable() {
    const tbody = document.getElementById('couponsTableBody');
    const coupons = allUsers._coupons || [];
    const serviceNames = {'images':'üîç Image Stock','ai-image':'üé® Image Generator','ai-video':'üé¨ Video Generator'};
    if (coupons.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px">No coupons</td></tr>'; return; }
    tbody.innerHTML = coupons.map((c, i) => `<tr><td><strong style="color:#3fb950">${c.code}</strong></td><td>${serviceNames[c.service]}</td><td>${c.type}</td><td><span class="badge ${c.status === 'active' ? 'active' : 'expired'}">${c.status}</span></td><td>${new Date(c.createdAt).toLocaleDateString()}</td><td><button class="action-btn danger" onclick="deleteCoupon(${i})">üóëÔ∏è</button></td></tr>`).join('');
}

async function deleteCoupon(index) {
    if (!confirm('Delete coupon?')) return;
    const users = await BLSC_ACCOUNT.getUsers();
    users._coupons.splice(index, 1);
    await BLSC_ACCOUNT.saveUsers(users);
    await loadAllData();
}

async function refreshData() { BLSC_ACCOUNT._usersCache = null; await loadAllData(); alert('‚úÖ Refreshed'); }

// Ban system
async function banUser(email) {
    const reason = prompt('Enter ban reason (optional):') || 'Violation of terms';
    if (!confirm(`üî® BAN user ${email}?\nReason: ${reason}`)) return;
    const users = await BLSC_ACCOUNT.getUsers();
    users[email].banned = true;
    users[email].banReason = reason;
    users[email].bannedAt = new Date().toISOString();
    // Clear their subscriptions
    users[email].subscriptions = {};
    await BLSC_ACCOUNT.saveUsers(users);
    alert('üö´ User BANNED: ' + email);
    await loadAllData();
}

async function unbanUser(email) {
    if (!confirm(`Unban user ${email}?`)) return;
    const users = await BLSC_ACCOUNT.getUsers();
    users[email].banned = false;
    delete users[email].banReason;
    delete users[email].bannedAt;
    await BLSC_ACCOUNT.saveUsers(users);
    alert('‚úÖ User unbanned: ' + email);
    await loadAllData();
}

function renderBannedTable() {
    const tbody = document.getElementById('bannedTableBody');
    const bannedList = Object.values(allUsers).filter(u => u.banned);
    if (bannedList.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">No banned users</td></tr>'; return; }
    tbody.innerHTML = bannedList.map(user => {
        const color = '#ef4444';
        const initials = BLSC_ACCOUNT.getInitials(user.name);
        return `<tr style="background:rgba(239,68,68,0.05)"><td><div class="user-info"><div class="user-avatar" style="background:${color}">${initials}</div><div><div class="user-name" style="color:#ef4444">${user.name}</div></div></div></td><td>${user.email}</td><td>${user.bannedAt ? new Date(user.bannedAt).toLocaleDateString() : 'Unknown'}</td><td style="color:#ef4444">${user.banReason || 'No reason'}</td><td><button class="action-btn primary" onclick="unbanUser('${user.email}')">‚úÖ Unban</button><button class="action-btn danger" onclick="deleteUser('${user.email}')">üóëÔ∏è Delete</button></td></tr>`;
    }).join('');
}

function exportAllData() {
    const data = JSON.stringify(allUsers, null, 2);
    const blob = new Blob([data], {type: 'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'blsc_backup_' + new Date().toISOString().split('T')[0] + '.json'; a.click();
}

// ========== SYSTEM STATUS MONITOR ==========
let systemOnline = false;

async function checkSystemStatus() {
    const startTime = Date.now();
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${BLSC_ACCOUNT.JSONBIN_BIN_ID}/latest`, {
            headers: { 'X-Access-Key': BLSC_ACCOUNT.JSONBIN_API_KEY }
        });
        const pingTime = Date.now() - startTime;
        
        if (response.ok) {
            setSystemOnline(true, pingTime);
        } else {
            setSystemOnline(false);
        }
    } catch (error) {
        setSystemOnline(false);
    }
}

function setSystemOnline(online, ping = 0) {
    systemOnline = online;
    const statusBar = document.getElementById('systemStatus');
    const statusText = document.getElementById('statusText');
    const cloudStatus = document.getElementById('cloudStatus');
    const lastSync = document.getElementById('lastSync');
    const pingTime = document.getElementById('pingTime');
    
    if (!statusBar) return;
    
    if (online) {
        statusBar.classList.remove('status-offline');
        statusText.innerHTML = 'üü¢ SYSTEM ONLINE';
        cloudStatus.textContent = 'Connected';
        cloudStatus.style.color = '#3fb950';
        pingTime.textContent = ping + 'ms';
        pingTime.style.color = ping < 500 ? '#3fb950' : ping < 1000 ? '#eab308' : '#ef4444';
    } else {
        statusBar.classList.add('status-offline');
        statusText.innerHTML = 'üî¥ SYSTEM OFFLINE';
        cloudStatus.textContent = 'Disconnected';
        cloudStatus.style.color = '#ef4444';
        pingTime.textContent = '--ms';
        pingTime.style.color = '#ef4444';
    }
    
    lastSync.textContent = new Date().toLocaleTimeString();
}

// Check status every 30 seconds
setInterval(checkSystemStatus, 30000);

// Initial check when admin panel loads
setTimeout(checkSystemStatus, 1000);
</script>