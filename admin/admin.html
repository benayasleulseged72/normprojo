<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLSC Admin Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;background:#1f242d;min-height:100vh;color:#fff}
        .admin-panel{padding:20px;max-width:1400px;margin:0 auto}
        .admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:20px}
        .admin-header h1{font-size:28px}.admin-header h1 span{color:#3fb950}
        .logout-btn{padding:12px 24px;background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.5);border-radius:100px;color:#ef4444;font-size:14px;cursor:pointer}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:30px}
        .stat-card{background:rgba(0,0,0,0.3);border:1px solid rgba(63,185,80,0.2);border-radius:16px;padding:24px;text-align:center}
        .stat-card .number{font-size:36px;font-weight:800;color:#3fb950}
        .stat-card .label{color:rgba(255,255,255,0.5);font-size:14px;margin-top:8px}
        .tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
        .tab{padding:12px 24px;background:rgba(0,0,0,0.3);border:1px solid rgba(63,185,80,0.2);border-radius:100px;color:rgba(255,255,255,0.7);font-size:14px;cursor:pointer}
        .tab.active{background:#3fb950;color:#1f242d;border-color:#3fb950;font-weight:600}
        .content-panel{display:none}.content-panel.active{display:block}
        .users-table{width:100%;border-collapse:collapse;background:rgba(0,0,0,0.3);border-radius:16px;overflow:hidden}
        .users-table th,.users-table td{padding:16px;text-align:left;border-bottom:1px solid rgba(63,185,80,0.1)}
        .users-table th{background:rgba(63,185,80,0.1);color:#3fb950;font-weight:600;font-size:13px}
        .users-table td{font-size:14px}
        .user-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600}
        .user-info{display:flex;align-items:center;gap:12px}
        .user-name{font-weight:600}.user-email{color:rgba(255,255,255,0.5);font-size:13px}
        .badge{padding:4px 12px;border-radius:100px;font-size:12px;font-weight:600}
        .badge.active{background:rgba(63,185,80,0.2);color:#3fb950}
        .badge.expired{background:rgba(239,68,68,0.2);color:#ef4444}
        .action-btn{padding:8px 16px;border-radius:8px;font-size:13px;cursor:pointer;margin-right:8px;border:none}
        .action-btn.primary{background:#3fb950;color:#1f242d}
        .action-btn.danger{background:rgba(239,68,68,0.3);color:#ef4444}
        .sub-form{background:rgba(0,0,0,0.3);border:1px solid rgba(63,185,80,0.2);border-radius:16px;padding:24px;margin-bottom:24px}
        .sub-form h3{margin-bottom:20px;font-size:18px;color:#3fb950}
        .sub-form .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:16px}
        .sub-form label{display:block;color:rgba(255,255,255,0.7);font-size:14px;margin-bottom:8px}
        .sub-form input,.sub-form select{width:100%;padding:14px;background:rgba(0,0,0,0.3);border:1px solid rgba(63,185,80,0.3);border-radius:12px;color:#fff;font-size:15px}
        .sub-form select option{background:#1f242d}
        .search-box{margin-bottom:20px}
        .search-box input{width:100%;max-width:400px;padding:14px 20px;background:rgba(0,0,0,0.3);border:1px solid rgba(63,185,80,0.3);border-radius:100px;color:#fff}
        #systemStatus{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:rgba(63,185,80,0.1);border:1px solid rgba(63,185,80,0.3);border-radius:12px;margin-bottom:20px;flex-wrap:wrap;gap:10px}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        @media(max-width:768px){.users-table{display:block;overflow-x:auto}}
    </style>
</head>
<body>
<div class="admin-panel">
    <div id="systemStatus">
        <div style="display:flex;align-items:center;gap:10px">
            <div style="width:12px;height:12px;border-radius:50%;background:#3fb950;animation:pulse 2s infinite"></div>
            <span id="statusText" style="color:#3fb950;font-weight:600">ğŸŸ¢ ONLINE</span>
        </div>
        <div style="font-size:13px;color:rgba(255,255,255,0.6)">â˜ï¸ <span id="cloudStatus" style="color:#3fb950">Connecting...</span> | ğŸ“¡ <span id="pingTime">--ms</span></div>
    </div>
    
    <div class="admin-header"><h1>ğŸ›¡ï¸ BLSC <span>Admin</span></h1><button class="logout-btn" onclick="adminLogout()">ğŸšª Logout</button></div>
    
    <div class="stats-grid">
        <div class="stat-card"><div class="number" id="totalUsers">0</div><div class="label">Users</div></div>
        <div class="stat-card"><div class="number" id="activeTrials">0</div><div class="label">Trials</div></div>
        <div class="stat-card"><div class="number" id="paidSubs">0</div><div class="label">Paid</div></div>
        <div class="stat-card"><div class="number" id="pendingPay">0</div><div class="label">Pending</div></div>
        <div class="stat-card" style="border-color:rgba(239,68,68,0.3)"><div class="number" id="bannedUsers" style="color:#ef4444">0</div><div class="label">Banned</div></div>
    </div>
   
    <div class="tabs">
        <button class="tab active" onclick="showTab('users')">ğŸ‘¥ Users</button>
        <button class="tab" onclick="showTab('payments')">ğŸ’° Payments</button>
        <button class="tab" onclick="showTab('subscriptions')">ğŸ’³ Subs</button>
        <button class="tab" onclick="showTab('coupons')">ğŸŸï¸ Coupons</button>
        <button class="tab" onclick="showTab('banned')">ğŸš« Banned</button>
        <button class="tab" onclick="showTab('settings')">âš™ï¸ Settings</button>
    </div>
    
    <div class="content-panel active" id="usersPanel">
        <div class="search-box"><input type="text" id="searchUsers" placeholder="ğŸ” Search..." oninput="filterUsers()"></div>
        <table class="users-table"><thead><tr><th>User</th><th>Created</th><th>Login</th><th>Subs</th><th>Actions</th></tr></thead>
        <tbody id="usersTableBody"><tr><td colspan="5" style="text-align:center;padding:40px">Loading...</td></tr></tbody></table>
    </div>
    
    <div class="content-panel" id="paymentsPanel">
        <h3 style="margin-bottom:20px;color:#3fb950">ğŸ’° Pending Payments</h3>
        <table class="users-table"><thead><tr><th>User</th><th>Service</th><th>Plan</th><th>Amount</th><th>Method</th><th>Screenshot</th><th>Date</th><th>Actions</th></tr></thead>
        <tbody id="paymentsTableBody"><tr><td colspan="8" style="text-align:center;padding:40px">No pending</td></tr></tbody></table>
    </div>
    
    <div id="screenshotModal" onclick="if(event.target===this)closeScreenshot()" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:9999;align-items:center;justify-content:center">
        <div style="position:relative"><button onclick="closeScreenshot()" style="position:absolute;top:-40px;right:0;background:#ef4444;border:none;color:#fff;padding:10px 20px;border-radius:8px;cursor:pointer">âœ•</button>
        <img id="modalScreenshot" style="max-width:90vw;max-height:80vh;border-radius:12px;border:2px solid #3fb950"></div>
    </div>
    
    <div class="content-panel" id="subscriptionsPanel">
        <div class="sub-form"><h3>â• Add Subscription</h3>
            <div class="form-row"><div><label>Email</label><input type="email" id="subEmail" placeholder="user@email.com"></div>
            <div><label>Service</label><select id="subService"><option value="images">ğŸ” Images</option><option value="ai-image">ğŸ¨ AI Image</option><option value="ai-video">ğŸ¬ AI Video</option></select></div></div>
            <div class="form-row"><div><label>Plan</label><select id="subType"><option value="free_trial">Trial 30d</option><option value="monthly">Monthly</option><option value="yearly">Yearly</option><option value="unlimited">Unlimited</option></select></div>
            <div><label>&nbsp;</label><button class="action-btn primary" style="width:100%;padding:14px" onclick="addSubscription()">âœ… Activate</button></div></div>
        </div>
        <table class="users-table"><thead><tr><th>User</th><th>Service</th><th>Type</th><th>Status</th><th>Expires</th><th>Actions</th></tr></thead>
        <tbody id="subsTableBody"><tr><td colspan="6" style="text-align:center;padding:40px">No subs</td></tr></tbody></table>
    </div>
    
    <div class="content-panel" id="couponsPanel">
        <div class="sub-form"><h3>ğŸŸï¸ Generate Coupon</h3>
            <div class="form-row"><div><label>Service</label><select id="couponService"><option value="images">ğŸ” Images</option><option value="ai-image">ğŸ¨ AI Image</option><option value="ai-video">ğŸ¬ AI Video</option></select></div>
            <div><label>Plan</label><select id="couponType"><option value="monthly">Monthly</option><option value="yearly">Yearly</option><option value="unlimited">Unlimited</option></select></div></div>
            <button class="action-btn primary" style="padding:14px 30px" onclick="generateCoupon()">ğŸ« Generate</button>
        </div>
        <table class="users-table"><thead><tr><th>Code</th><th>Service</th><th>Plan</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead>
        <tbody id="couponsTableBody"><tr><td colspan="6" style="text-align:center;padding:40px">No coupons</td></tr></tbody></table>
    </div>
    
    <div class="content-panel" id="bannedPanel">
        <h3 style="margin-bottom:20px;color:#ef4444">ğŸš« Banned Users</h3>
        <table class="users-table"><thead><tr><th>User</th><th>Email</th><th>Banned</th><th>Reason</th><th>Actions</th></tr></thead>
        <tbody id="bannedTableBody"><tr><td colspan="5" style="text-align:center;padding:40px">No banned</td></tr></tbody></table>
    </div>
    
    <div class="content-panel" id="settingsPanel">
        <div class="sub-form"><h3>âš™ï¸ Settings</h3>
            <div><label>Database</label><input type="text" id="binId" value="Firebase Realtime DB" disabled style="opacity:0.5"></div>
            <div style="margin-top:20px"><button class="action-btn primary" onclick="refreshData()">ğŸ”„ Refresh</button><button class="action-btn danger" onclick="exportAllData()">ğŸ“¥ Export</button></div>
        </div>
    </div>
</div>

<script src="../blsc-account.js"></script>
<script>
const ADMIN_KEY='blsc_admin_session';
const FIREBASE_DB_URL='https://blsc-accounts-206b9-default-rtdb.firebaseio.com';
let allUsers={};

// Check login
if(localStorage.getItem(ADMIN_KEY)!=='logged_in'){
    window.location.href='index.html';
}

// Initialize
loadAllData();
checkSystemStatus();
setInterval(loadAllData, 3000);
setInterval(checkSystemStatus, 30000);

function adminLogout(){
    localStorage.removeItem(ADMIN_KEY);
    window.location.href='index.html';
}

async function loadAllData(){
    try{
        BLSC_ACCOUNT._usersCache=null;
        BLSC_ACCOUNT._cacheTime=null;
        allUsers=await BLSC_ACCOUNT.getUsers();
        updateStats();
        renderUsersTable();
        renderSubscriptionsTable();
        renderPaymentsTable();
        renderCouponsTable();
        renderBannedTable();
    }catch(e){console.error('Load error:',e);}
}

function getInitials(name){
    if(!name)return'?';
    const p=name.trim().split(' ');
    return p.length>=2?(p[0][0]+p[p.length-1][0]).toUpperCase():name.substring(0,2).toUpperCase();
}

function getAvatarColor(name){
    const colors=['#3fb950','#58a6ff','#8b5cf6','#f97316','#ec4899','#14b8a6','#eab308'];
    let h=0;for(let i=0;i<name.length;i++)h=name.charCodeAt(i)+((h<<5)-h);
    return colors[Math.abs(h)%colors.length];
}

function updateStats(){
    const list=Object.values(allUsers).filter(u=>typeof u==='object'&&u.email);
    let trials=0,paid=0,pending=0,banned=0;
    list.forEach(u=>{
        if(u.banned){banned++;return;}
        if(u.subscriptions)Object.values(u.subscriptions).forEach(s=>{
            if(s.type==='unlimited'||new Date()<new Date(s.endDate)){s.type==='free_trial'?trials++:paid++;}
        });
        if(u.pendingPayments)pending+=u.pendingPayments.filter(p=>p.status==='pending').length;
    });
    document.getElementById('totalUsers').textContent=list.filter(u=>!u.banned).length;
    document.getElementById('activeTrials').textContent=trials;
    document.getElementById('paidSubs').textContent=paid;
    document.getElementById('pendingPay').textContent=pending;
    document.getElementById('bannedUsers').textContent=banned;
}

function renderUsersTable(f=''){
    const tbody=document.getElementById('usersTableBody');
    const list=Object.values(allUsers).filter(u=>u.email&&!u.banned);
    if(!list.length){tbody.innerHTML='<tr><td colspan="5" style="text-align:center;padding:40px">No users</td></tr>';return;}
    const filtered=f?list.filter(u=>(u.name||'').toLowerCase().includes(f.toLowerCase())||u.email.toLowerCase().includes(f.toLowerCase())):list;
    tbody.innerHTML=filtered.map(u=>{
        const c=getAvatarColor(u.name||'U'),i=getInitials(u.name||'User'),s=u.subscriptions?Object.keys(u.subscriptions).length:0;
        const emailKey=u.email.replace(/\./g,'_');
        return `<tr><td><div class="user-info"><div class="user-avatar" style="background:${c}">${i}</div><div><div class="user-name">${u.name||'Unknown'}</div><div class="user-email">${u.email}</div></div></div></td><td>${new Date(u.createdAt).toLocaleDateString()}</td><td>${u.lastLogin?new Date(u.lastLogin).toLocaleDateString():'-'}</td><td><span class="badge ${s>0?'active':'none'}">${s}</span></td><td><button class="action-btn primary" onclick="editUser('${u.email}')">âœï¸</button><button class="action-btn" style="background:#ff6b00;color:#fff" onclick="banUser('${emailKey}')">ğŸ”¨</button><button class="action-btn danger" onclick="deleteUser('${emailKey}')">ğŸ—‘ï¸</button></td></tr>`;
    }).join('');
}

function renderSubscriptionsTable(){
    const tbody=document.getElementById('subsTableBody'),rows=[],n={'images':'ğŸ”','ai-image':'ğŸ¨','ai-video':'ğŸ¬'};
    Object.values(allUsers).forEach(u=>{
        if(u.subscriptions)Object.entries(u.subscriptions).forEach(([s,sub])=>{
            const a=sub.type==='unlimited'||new Date()<new Date(sub.endDate);
            const emailKey=u.email.replace(/\./g,'_');
            rows.push(`<tr><td>${u.email}</td><td>${n[s]||s}</td><td>${sub.type}</td><td><span class="badge ${a?'active':'expired'}">${a?'Active':'Expired'}</span></td><td>${sub.endDate?new Date(sub.endDate).toLocaleDateString():'Never'}</td><td><button class="action-btn danger" onclick="removeSub('${emailKey}','${s}')">ğŸ—‘ï¸</button></td></tr>`);
        });
    });
    tbody.innerHTML=rows.length?rows.join(''):'<tr><td colspan="6" style="text-align:center;padding:40px">No subs</td></tr>';
}

function renderPaymentsTable(){
    const tbody=document.getElementById('paymentsTableBody'),rows=[],n={'images':'ğŸ”','ai-image':'ğŸ¨','ai-video':'ğŸ¬'};
    Object.values(allUsers).forEach(u=>{
        if(u.pendingPayments)u.pendingPayments.forEach((p,i)=>{
            if(p.status==='pending'){
                const emailKey=u.email.replace(/\./g,'_');
                rows.push(`<tr><td>${u.email}</td><td>${n[p.service]||p.service}</td><td>${p.plan}</td><td><strong>${p.amount}Br</strong></td><td>${p.method}</td><td><button class="action-btn" style="background:#58a6ff;color:#fff" onclick="viewScreenshotFull('${emailKey}',${i})">ğŸ“·</button></td><td>${new Date(p.createdAt).toLocaleDateString()}</td><td><button class="action-btn primary" onclick="approvePayment('${emailKey}',${i})">âœ…</button><button class="action-btn danger" onclick="rejectPayment('${emailKey}',${i})">âŒ</button></td></tr>`);
            }
        });
    });
    tbody.innerHTML=rows.length?rows.join(''):'<tr><td colspan="8" style="text-align:center;padding:40px">No pending</td></tr>';
}

function renderCouponsTable(){
    const tbody=document.getElementById('couponsTableBody'),c=allUsers._coupons||[],n={'images':'ğŸ”','ai-image':'ğŸ¨','ai-video':'ğŸ¬'};
    if(!c.length){tbody.innerHTML='<tr><td colspan="6" style="text-align:center;padding:40px">No coupons</td></tr>';return;}
    tbody.innerHTML=c.map((x,i)=>`<tr><td><strong style="color:#3fb950">${x.code}</strong></td><td>${n[x.service]}</td><td>${x.type}</td><td><span class="badge ${x.status==='active'?'active':'expired'}">${x.status}</span></td><td>${new Date(x.createdAt).toLocaleDateString()}</td><td><button class="action-btn danger" onclick="deleteCoupon(${i})">ğŸ—‘ï¸</button></td></tr>`).join('');
}

function renderBannedTable(){
    const tbody=document.getElementById('bannedTableBody'),b=Object.values(allUsers).filter(u=>u.banned);
    if(!b.length){tbody.innerHTML='<tr><td colspan="5" style="text-align:center;padding:40px">No banned</td></tr>';return;}
    tbody.innerHTML=b.map(u=>{
        const emailKey=u.email.replace(/\./g,'_');
        return `<tr style="background:rgba(239,68,68,0.05)"><td><div class="user-info"><div class="user-avatar" style="background:#ef4444">${getInitials(u.name||'U')}</div><div class="user-name" style="color:#ef4444">${u.name||'?'}</div></div></td><td>${u.email}</td><td>${u.bannedAt?new Date(u.bannedAt).toLocaleDateString():'-'}</td><td style="color:#ef4444">${u.banReason||'-'}</td><td><button class="action-btn primary" onclick="unbanUser('${emailKey}')">âœ…</button><button class="action-btn danger" onclick="deleteUser('${emailKey}')">ğŸ—‘ï¸</button></td></tr>`;
    }).join('');
}

function viewScreenshotFull(key,i){const u=allUsers[key];if(u?.pendingPayments?.[i]?.screenshotUrl){document.getElementById('modalScreenshot').src=u.pendingPayments[i].screenshotUrl;document.getElementById('screenshotModal').style.display='flex';}}
function closeScreenshot(){document.getElementById('screenshotModal').style.display='none';}
function filterUsers(){renderUsersTable(document.getElementById('searchUsers').value);}
function showTab(t){document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.content-panel').forEach(x=>x.classList.remove('active'));event.target.classList.add('active');document.getElementById(t+'Panel').classList.add('active');}

async function addSubscription(){
    const e=document.getElementById('subEmail').value,s=document.getElementById('subService').value,t=document.getElementById('subType').value;
    const key=e.replace(/\./g,'_');
    if(!e||!allUsers[key]){alert('User not found');return;}
    const d={'free_trial':30,'monthly':30,'yearly':365,'unlimited':0};
    await BLSC_ACCOUNT.activateSubscription(e,s,t,d[t]);
    alert('âœ… Done');await loadAllData();
}

async function removeSub(key,s){if(!confirm('Remove?'))return;const u=await BLSC_ACCOUNT.getUsers();if(u[key]?.subscriptions){delete u[key].subscriptions[s];await BLSC_ACCOUNT.saveUsers(u);await loadAllData();}}
async function deleteUser(key){if(!confirm('Delete user?'))return;const u=await BLSC_ACCOUNT.getUsers();delete u[key];await BLSC_ACCOUNT.saveUsers(u);await loadAllData();}
function editUser(e){document.getElementById('subEmail').value=e;showTab('subscriptions');}

async function approvePayment(key,i){
    const u=await BLSC_ACCOUNT.getUsers(),p=u[key].pendingPayments[i];
    if(!confirm('Approve '+p.amount+'Br?'))return;
    const d={'monthly':30,'yearly':365,'unlimited':0};
    const email=u[key].email;
    await BLSC_ACCOUNT.activateSubscription(email,p.service,p.plan,d[p.plan]);
    u[key].pendingPayments[i].status='approved';
    await BLSC_ACCOUNT.saveUsers(u);alert('âœ…');await loadAllData();
}

async function rejectPayment(key,i){if(!confirm('Reject?'))return;const u=await BLSC_ACCOUNT.getUsers();u[key].pendingPayments[i].status='rejected';await BLSC_ACCOUNT.saveUsers(u);await loadAllData();}

async function generateCoupon(){
    const s=document.getElementById('couponService').value,t=document.getElementById('couponType').value;
    const c='BLSC-'+Math.random().toString(36).substring(2,8).toUpperCase();
    const u=await BLSC_ACCOUNT.getUsers();
    if(!u._coupons)u._coupons=[];
    u._coupons.push({code:c,service:s,type:t,status:'active',createdAt:new Date().toISOString()});
    await BLSC_ACCOUNT.saveUsers(u);alert('âœ… '+c);await loadAllData();
}

async function deleteCoupon(i){if(!confirm('Delete?'))return;const u=await BLSC_ACCOUNT.getUsers();u._coupons.splice(i,1);await BLSC_ACCOUNT.saveUsers(u);await loadAllData();}

async function banUser(key){
    const r=prompt('Reason:')||'Violation';
    if(!confirm('ğŸ”¨ BAN user?'))return;
    const u=await BLSC_ACCOUNT.getUsers();
    u[key].banned=true;u[key].banReason=r;u[key].bannedAt=new Date().toISOString();u[key].subscriptions={};
    await BLSC_ACCOUNT.saveUsers(u);alert('ğŸš« BANNED');await loadAllData();
}

async function unbanUser(key){if(!confirm('Unban?'))return;const u=await BLSC_ACCOUNT.getUsers();u[key].banned=false;delete u[key].banReason;delete u[key].bannedAt;await BLSC_ACCOUNT.saveUsers(u);await loadAllData();}

async function refreshData(){BLSC_ACCOUNT._usersCache=null;BLSC_ACCOUNT._cacheTime=null;await loadAllData();checkSystemStatus();alert('âœ…');}

function exportAllData(){const b=new Blob([JSON.stringify(allUsers,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='blsc_'+new Date().toISOString().split('T')[0]+'.json';a.click();}

async function checkSystemStatus(){
    const s=Date.now();
    try{
        const r=await fetch(`${FIREBASE_DB_URL}/users.json`);
        const p=Date.now()-s;
        if(r.ok){
            document.getElementById('statusText').innerHTML='ğŸŸ¢ ONLINE';
            document.getElementById('cloudStatus').textContent='Firebase Connected';
            document.getElementById('cloudStatus').style.color='#3fb950';
            document.getElementById('pingTime').textContent=p+'ms';
            document.getElementById('pingTime').style.color=p<500?'#3fb950':'#eab308';
        }else throw new Error();
    }catch{
        document.getElementById('statusText').innerHTML='ğŸ”´ OFFLINE';
        document.getElementById('cloudStatus').textContent='Disconnected';
        document.getElementById('cloudStatus').style.color='#ef4444';
    }
}
</script>
</body>
</html>